<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ARIJIT PANDA - Dream to Success</title>
    <meta name="description" content="Private admin dashboard for business operations management.">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="js/api.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- Admin Login Form -->
        <div id="adminLogin" class="admin-login">
            <div class="admin-login-header">
                <h1><i class="fas fa-lock"></i> Admin Access</h1>
                <p>ARIJIT PANDA - Dream to Success</p>
            </div>
            <div class="admin-login-form">
                <div id="loginMessage"></div>
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <button type="button" class="admin-login-btn" onclick="adminLogin()">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </div>
        </div>

        <!-- Admin Dashboard Content -->
        <div id="adminDashboard" class="admin-dashboard-content">
            <div class="admin-header">
                <div>
                    <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>
                    <div class="owner-info">
                        <h3>Arijit Panda</h3>
                        <p>Commerce Graduate, CA & CMA Pursuing, Registered GST Practitioner</p>
                    </div>
                </div>
                <button class="admin-logout-btn" onclick="adminLogout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
            <div class="admin-body">
                <div id="dashboardMessage"></div>
                
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalContacts">-</h3>
                            <p>Total Contacts</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalUsers">-</h3>
                            <p>Total Users</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="recentContacts">-</h3>
                            <p>Recent (7 days)</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="newContacts">-</h3>
                            <p>New Messages</p>
                        </div>
                    </div>
                </div>

                <!-- Contacts Management -->
                <div class="admin-section">
                    <div class="section-header">
                        <h2><i class="fas fa-envelope"></i> Contact Management</h2>
                        <div class="controls">
                            <input type="text" id="searchContacts" placeholder="Search contacts..." class="form-control">
                            <select id="statusFilter" class="form-control">
                                <option value="all">All Status</option>
                                <option value="new">New</option>
                                <option value="read">Read</option>
                                <option value="replied">Replied</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                    </div>

                    <div class="contacts-table-container">
                        <table class="contacts-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Subject</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="contactsTableBody">
                                <!-- Contacts will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="pagination">
                        <!-- Pagination buttons will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Detail Modal -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Contact Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="contactModalBody">
                <!-- Contact details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" onclick="updateContactStatus()">Update Status</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentPage = 1;
        let totalPages = 1;
        let contacts = [];
        let selectedContactId = null;

        // Check if user is already logged in
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('adminToken');
            if (token) {
                // Verify token and show dashboard
                verifyAdminToken(token);
            }
        });

        // Admin Login Function
        async function adminLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');

            if (!username || !password) {
                showMessage(messageDiv, 'Please enter both username and password', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok && data.user.role === 'owner') {
                    localStorage.setItem('adminToken', data.token);
                    currentUser = data.user;
                    showDashboard();
                    loadDashboardStats();
                    loadContacts();
                } else {
                    showMessage(messageDiv, 'Invalid credentials or insufficient privileges', 'error');
                }
            } catch (error) {
                showMessage(messageDiv, 'Login failed. Please try again.', 'error');
            }
        }

        // Verify Admin Token
        async function verifyAdminToken(token) {
            try {
                const response = await fetch('/api/auth/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok && data.user.role === 'owner') {
                    currentUser = data.user;
                    showDashboard();
                    loadDashboardStats();
                    loadContacts();
                } else {
                    localStorage.removeItem('adminToken');
                    showLogin();
                }
            } catch (error) {
                localStorage.removeItem('adminToken');
                showLogin();
            }
        }

        // Show Dashboard
        function showDashboard() {
            document.getElementById('adminLogin').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
        }

        // Show Login
        function showLogin() {
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Admin Logout
        function adminLogout() {
            localStorage.removeItem('adminToken');
            currentUser = null;
            showLogin();
        }

        // Load Dashboard Stats
        async function loadDashboardStats() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalContacts').textContent = stats.totalContacts || 0;
                    document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
                    document.getElementById('recentContacts').textContent = stats.recentContacts || 0;
                    document.getElementById('newContacts').textContent = stats.newContacts || 0;
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Load Contacts
        async function loadContacts(page = 1) {
            try {
                const token = localStorage.getItem('adminToken');
                const searchTerm = document.getElementById('searchContacts').value;
                const statusFilter = document.getElementById('statusFilter').value;

                let url = `/api/admin/contacts?page=${page}`;
                if (searchTerm) url += `&search=${encodeURIComponent(searchTerm)}`;
                if (statusFilter !== 'all') url += `&status=${statusFilter}`;

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    contacts = data.contacts || [];
                    totalPages = data.totalPages || 1;
                    currentPage = page;
                    
                    displayContacts();
                    displayPagination();
                }
            } catch (error) {
                console.error('Error loading contacts:', error);
            }
        }

        // Display Contacts
        function displayContacts() {
            const tbody = document.getElementById('contactsTableBody');
            tbody.innerHTML = '';

            if (contacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No contacts found</td></tr>';
                return;
            }

            contacts.forEach(contact => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${contact.name}</td>
                    <td>${contact.email}</td>
                    <td>${contact.phone || '-'}</td>
                    <td>${contact.subject}</td>
                    <td><span class="status-badge status-${contact.status || 'new'}">${contact.status || 'new'}</span></td>
                    <td>${new Date(contact.created_at).toLocaleDateString()}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-small btn-view" onclick="viewContact(${contact.id})">View</button>
                            <button class="btn-small btn-edit" onclick="editContact(${contact.id})">Edit</button>
                            <button class="btn-small btn-delete" onclick="deleteContact(${contact.id})">Delete</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Display Pagination
        function displayPagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = 'Previous';
            prevBtn.disabled = currentPage === 1;
            prevBtn.onclick = () => loadContacts(currentPage - 1);
            pagination.appendChild(prevBtn);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === currentPage ? 'active' : '';
                pageBtn.onclick = () => loadContacts(i);
                pagination.appendChild(pageBtn);
            }

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next';
            nextBtn.disabled = currentPage === totalPages;
            nextBtn.onclick = () => loadContacts(currentPage + 1);
            pagination.appendChild(nextBtn);
        }

        // Search and Filter
        document.getElementById('searchContacts').addEventListener('input', debounce(() => {
            loadContacts(1);
        }, 500));

        document.getElementById('statusFilter').addEventListener('change', () => {
            loadContacts(1);
        });

        // View Contact
        async function viewContact(id) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/contacts/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const contact = await response.json();
                    selectedContactId = id;
                    showContactModal(contact);
                }
            } catch (error) {
                console.error('Error loading contact:', error);
            }
        }

        // Show Contact Modal
        function showContactModal(contact) {
            const modal = document.getElementById('contactModal');
            const modalBody = document.getElementById('contactModalBody');
            
            modalBody.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <strong>Name:</strong> ${contact.name}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Email:</strong> ${contact.email}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Phone:</strong> ${contact.phone || 'Not provided'}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Subject:</strong> ${contact.subject}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Message:</strong><br>
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px; margin-top: 0.5rem;">
                        ${contact.message}
                    </div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Status:</strong>
                    <select id="contactStatus" class="form-control" style="margin-left: 0.5rem;">
                        <option value="new" ${contact.status === 'new' ? 'selected' : ''}>New</option>
                        <option value="read" ${contact.status === 'read' ? 'selected' : ''}>Read</option>
                        <option value="replied" ${contact.status === 'replied' ? 'selected' : ''}>Replied</option>
                        <option value="closed" ${contact.status === 'closed' ? 'selected' : ''}>Closed</option>
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Notes:</strong><br>
                    <textarea id="contactNotes" class="form-control" style="margin-top: 0.5rem; width: 100%; height: 80px;" placeholder="Add notes about this contact...">${contact.notes || ''}</textarea>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Close Modal
        function closeModal() {
            document.getElementById('contactModal').style.display = 'none';
            selectedContactId = null;
        }

        // Update Contact Status
        async function updateContactStatus() {
            if (!selectedContactId) return;

            const status = document.getElementById('contactStatus').value;
            const notes = document.getElementById('contactNotes').value;

            try {
                const token = localStorage.getItem('adminToken');
                
                // Update status
                await fetch(`/api/admin/contacts/${selectedContactId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status })
                });

                // Add notes if provided
                if (notes.trim()) {
                    await fetch(`/api/admin/contacts/${selectedContactId}/note`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ note: notes })
                    });
                }

                closeModal();
                loadContacts(currentPage);
                loadDashboardStats();
                showMessage(document.getElementById('dashboardMessage'), 'Contact updated successfully', 'success');
            } catch (error) {
                console.error('Error updating contact:', error);
                showMessage(document.getElementById('dashboardMessage'), 'Failed to update contact', 'error');
            }
        }

        // Edit Contact
        function editContact(id) {
            viewContact(id);
        }

        // Delete Contact
        async function deleteContact(id) {
            if (!confirm('Are you sure you want to delete this contact?')) return;

            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/contacts/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    loadContacts(currentPage);
                    loadDashboardStats();
                    showMessage(document.getElementById('dashboardMessage'), 'Contact deleted successfully', 'success');
                }
            } catch (error) {
                console.error('Error deleting contact:', error);
                showMessage(document.getElementById('dashboardMessage'), 'Failed to delete contact', 'error');
            }
        }

        // Show Message
        function showMessage(container, message, type) {
            container.innerHTML = `<div class="${type === 'error' ? 'error-message' : 'success-message'}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('contactModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>
